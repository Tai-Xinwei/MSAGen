<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Pipeline &mdash; A4SFramework ai4science documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->

        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=c1325062"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Training Args" href="trainargs.html" />
    <link rel="prev" title="Model Zoo" href="modelzoo.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >



          <a href="index.html" class="icon icon-home">
            A4SFramework
          </a>
              <div class="version">
                0.0.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="userfriendly.html">User-friendly Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed.html">Large Distributed Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="modelzoo.html">Model Zoo</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dynamic-batching">Dynamic Batching</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sfm.data.dataset.FoundationModelDataset.num_tokens"><code class="docutils literal notranslate"><span class="pre">FoundationModelDataset.num_tokens()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#weighted-distributed-sampler">Weighted Distributed Sampler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sfm.data.sampler.WeightedDistributedSampler"><code class="docutils literal notranslate"><span class="pre">WeightedDistributedSampler</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="trainargs.html">Training Args</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">sfm</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">A4SFramework</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Data Pipeline</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/datapipeline.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <section id="data-pipeline">
<span id="datapipeline"></span><h1>Data Pipeline<a class="headerlink" href="#data-pipeline" title="Link to this heading"></a></h1>
<section id="dynamic-batching">
<h2>Dynamic Batching<a class="headerlink" href="#dynamic-batching" title="Link to this heading"></a></h2>
<p>Dynamic batching is a technique used in training deep learning models, especially when dealing with sequences of varying lengths, such as in natural language processing (NLP) tasks. The primary goal of dynamic batching is to enhance efficiency and decrease computational overhead during the training process. This is achieved by grouping sequences with similar lengths into the same batch, which significantly reduces the amount of padding needed. Consequently, the model processes fewer padding tokens, leading to reduced computational overhead and faster training.</p>
<p>In addition to NLP tasks, dynamic batching can also be applied to biological sequences, such as nucleotide or amino acid sequences, to optimize the training process. Just like in NLP, grouping sequences of similar lengths together in the same batch minimizes the need for padding, resulting in lower computational overhead and accelerated training. In summary, dynamic batching is a valuable technique for efficiently training deep learning models on sequences of varying lengths across multiple domains, including NLP and bioinformatics.</p>
<p>The figure <a class="reference internal" href="#dynamicbatching"><span class="std std-ref">Epoch vs. training time</span></a> shows the dynamic batching speed up the training process of protein data with more than 4 times. This significant improvement in training time demonstrates the effectiveness of dynamic batching in optimizing the deep learning model training process for sequences with varying lengths.</p>
<figure class="align-center" id="id1">
<span id="dynamicbatching"></span><a class="reference internal image-reference" href="_images/dynamicbatching.png"><img alt="Epoch vs. training time" src="_images/dynamicbatching.png" style="width: 501.0px; height: 236.0px;" /></a>
<figcaption>
<p><span class="caption-text">Epoch vs. training time</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>To use the feature, your dataset needs to inheret from <a class="reference internal" href="api/sfm.data.html#sfm.data.dataset.FoundationModelDataset" title="sfm.data.dataset.FoundationModelDataset"><code class="xref py py-class docutils literal notranslate"><span class="pre">sfm.data.dataset.FoundationModelDataset</span></code></a> and implement the following methods:</p>
<dl class="py method">
<dt class="sig sig-object py" id="sfm.data.dataset.FoundationModelDataset.num_tokens">
<span class="sig-prename descclassname"><span class="pre">FoundationModelDataset.</span></span><span class="sig-name descname"><span class="pre">num_tokens</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">index</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">int</span></span></span><a class="headerlink" href="#sfm.data.dataset.FoundationModelDataset.num_tokens" title="Link to this definition"></a></dt>
<dd></dd></dl>

<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">sfm.data.prot_data.ProteinLMDBDataset</span></code> shows an example of how to implement the above methods. Also, The flag <code class="docutils literal notranslate"><span class="pre">--dynamic_loader</span></code>, <code class="docutils literal notranslate"><span class="pre">--max_tokens</span></code> and <code class="docutils literal notranslate"><span class="pre">--max_length</span></code> needs to be set in the script. Find the details in the following example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">scripts</span><span class="o">/</span><span class="n">pfm</span><span class="o">/</span><span class="n">pretrain_pfm</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</section>
<section id="weighted-distributed-sampler">
<h2>Weighted Distributed Sampler<a class="headerlink" href="#weighted-distributed-sampler" title="Link to this heading"></a></h2>
<p>When training deep learning models with multiple datasets, it is essential to manage the distribution of samples to ensure that each dataset contributes effectively to the training process. The Weighted Distributed Sampler is specifically designed to assign weights to each dataset, allowing for a balanced and efficient sampling strategy. This sampler is implemented in the class</p>
<dl class="py class">
<dt class="sig sig-object py" id="sfm.data.sampler.WeightedDistributedSampler">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sfm.data.sampler.</span></span><span class="sig-name descname"><span class="pre">WeightedDistributedSampler</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dataset</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Dataset</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weight_dict</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Dict</span><span class="p"><span class="pre">[</span></span><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">int</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">int</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">float</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_replicas</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rank</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seed</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">drop_last</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sfm.data.sampler.WeightedDistributedSampler" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">DistributedSampler</span></code></p>
</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="modelzoo.html" class="btn btn-neutral float-left" title="Model Zoo" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="trainargs.html" class="btn btn-neutral float-right" title="Training Args" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, MSR A4S team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
