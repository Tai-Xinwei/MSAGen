description: MSAdata_process

env_defaults:
  NODES: 1
  CPUS: 60
  WANDB_API_KEY:
  HF_TOKEN:

target:
  service: sing
  name: msrresrchvc
  workspace_name: sfm-ws

environment:
  image: ai4s-sfm:20240531.170731
  registry: msrmoldyn.azurecr.io
  username: msrmoldyn

storage:
  westus:
    storage_account_name: sfmstoragewestus
    container_name: psm
    mount_dir: /psm

code:
  local_dir: ../PSM

search:
  job_template:
    name: MSAData_process_msas-uniprot_subset_{lmdb_id}
    tags: [Project_Name:Science_Foundation_Model,ProjectID:PRJ-0209-A40,Experiment:SFM_PSM]
    sku: ${NODES}xC${CPUS}
    mpi: true
    # identity: managed
    process_count_per_node: 1
    command:
    - eval "$$(conda shell.bash hook)" && conda activate sfm
    - python setup_cython.py build_ext --inplace
    - pip install nvidia-dali-cuda120
    - export SHARD_ID={lmdb_id}
    - export N_TASKS=16
    - export WORK_NAME="msas-uniprot"
    - export SAS="sv=2023-01-03&st=2025-04-28T13%3A11%3A08Z&se=2025-04-29T13%3A11%3A08Z&skoid=269c63c0-8e8a-4109-8178-cf2b14a90e82&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2025-04-28T13%3A11%3A08Z&ske=2025-04-29T13%3A11%3A08Z&sks=b&skv=2023-01-03&sr=c&sp=racwl&sig=0o%2B1L4e%2FnWKu6sQbW9qHBKvb0YnHGdkwXCop3x9mzfY%3D"
    - bash /psm/xinwei/msadata/UniProt/process.sh
    submit_args:
      env:
        _AZUREML_SINGULARITY_JOB_UAI: /subscriptions/3eaeebff-de6e-4e20-9473-24de9ca067dc/resourceGroups/sfm-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/sfm-job-identity
      container_args:
        shm_size: 1024G
    preemptible: false

  type: hyperdrive
  sampling: grid
  max_trials: 999
  parallel_trials: 100
  params:
    - name: lmdb_id
      spec: discrete
      values: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
